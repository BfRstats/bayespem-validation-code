---
title: "Regression"
output:
    html_document:
        toc: true
        toc_depth: 2
        toc_float: true
---

# Preparations

```{r}
library(broom)
```

Scale function for z-transformation:
```{r}
scale_this <- function(x){
    (x - mean(x, na.rm = TRUE)) / sd(x, na.rm = TRUE)
}
```

Join the bias/estimation error data frame with the design parameters and z-transform them:
```{r}
dat <- bias_df %>% 
    left_join(datasets, by = "data_id") %>% 
    select(data_id, data_case, par_id, rep_id, 
           pi_true, se_true, sp_true, 
           n, n_se, n_sp, 
           `Bayesian-Mean`, `Rogan-Gladen`) %>% 
    mutate(pi_true = scale_this(pi_true),
           se_true = scale_this(se_true),
           sp_true = scale_this(sp_true),
           n       = scale_this(n),
           n_se    = scale_this(n_se),
           n_sp    = scale_this(n_sp)) %>%
    rename(error_BM = `Bayesian-Mean`,
           error_RG = `Rogan-Gladen`) %>% 
    print()
```

# Rogan-Gladen estimator

Linear regression of the Rogan-Gladen estimation error against the design parameters including 1st order interactions.

```{r}
fit_RG <- lm(
    error_RG ~ (pi_true + se_true + sp_true + n + n_se + n_sp)^2,
    data = dat
)
summary(fit_RG)
```

```{r, eval = FALSE}
plot(fit_RG)
```

```{r}
tidy_RG <- tidy(fit_RG) %>% 
    filter(term != "(Intercept)") %>% 
    mutate(estimator = "Rogan-Gladen") 
tidy_RG %>% 
    ggplot(aes(x = reorder(term, -estimate), y = estimate)) +
    geom_col(orientation = "x") +
    coord_flip() +
    theme_bw(base_size = 16)
```

# Bayesian estimator (MCMC mean)

Linear regression of the Bayesian mean's estimation error against the design parameters including 1st order interactions.

```{r}
fit_BM <- lm(
    error_BM ~ (pi_true + se_true + sp_true + n + n_se + n_sp)^2,
    data = dat
)
summary(fit_BM)
```

```{r, eval = FALSE}
plot(fit_BM)
```

```{r}
tidy_BM <- tidy(fit_BM) %>% 
    mutate(estimator = "Bayesian-Mean") %>% 
    filter(term != "(Intercept)")
tidy_BM %>% 
    ggplot(aes(x = reorder(term, -estimate), y = estimate)) +
    geom_col(orientation = "x") +
    coord_flip() +
    theme_bw(base_size = 16)
```

# Comparison

```{r}
bind_rows(tidy_BM, tidy_RG) %>%
    mutate(estimator = factor(estimator, 
                              levels = c("Bayesian-Mean", "Rogan-Gladen"),
                              ordered = TRUE)) %>% 
    ggplot(aes(x = reorder(term, -estimate), y = estimate, 
               fill = estimator)) +
    geom_col(position = "dodge") +
    scale_y_continuous("Estimate") +
    scale_fill_manual("", values = c("#d9d9d9", "#969696")) +
    coord_flip() +
    theme_bw(base_size = 12) +
    theme(axis.title.x = element_text(margin = margin(1, 0, 0, 0, "lines")),
          axis.title.y = element_blank(),
          legend.key.width = unit(1.5, "lines"),
          legend.key.height = unit(0.3, "lines")) +
    panel_border()
```
